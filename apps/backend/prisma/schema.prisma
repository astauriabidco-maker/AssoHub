// ASSOSHUB — Prisma Schema (SQLite)
// ⚠️ SQLite: No enum support → all status/role fields use String with @default

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ─────────────────────────────────────────────────
// 1. ASSOCIATION (Tenant)
// ─────────────────────────────────────────────────
model Association {
  id              String   @id @default(uuid())
  slug            String   @unique
  name            String
  // Type: FAMILY, CULTURAL, SPORTS, POLITICAL, RELIGIOUS, OTHER
  type            String   @default("OTHER")
  slogan          String?
  logo_url        String?
  address_street  String?
  address_city    String?
  address_zip     String?
  address_country String?
  contact_email   String?
  contact_phone   String?
  legal_form      String? // Ex: "Association loi 1901", "ONG", etc.
  is_active       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Contextual fields (depending on type)
  origin_village  String?  // FAMILY: village d'origine commun
  origin_region   String?  // FAMILY: région / département
  chieftaincy     String?  // FAMILY: chefferie d'appartenance

  // Hierarchy (Federation / Antennes)
  parentId        String?
  parent          Association?  @relation("AssociationHierarchy", fields: [parentId], references: [id])
  children        Association[] @relation("AssociationHierarchy")
  networkLevel    String        @default("LOCAL") // INTERNATIONAL, NATIONAL, REGIONAL, LOCAL

  // Relations
  users         User[]
  roles         Role[]
  groups        Group[]
  campaigns     Campaign[]
  transactions  Transaction[]
  events        Event[]
  documents     Document[]
  announcements Announcement[]
  branchFees         Fee[]              @relation("BranchFees")
  familyLinks        FamilyLink[]
  skills             Skill[]
  secondaryMembers   UserAssociation[]  @relation("SecondaryMembers")
  branches           FamilyBranch[]
  treasuryAccounts   TreasuryAccount[]
  paymentConfig      PaymentConfig?
}

// ─────────────────────────────────────────────────
// 1b. ROLE (Dynamic per Association)
// ─────────────────────────────────────────────────
model Role {
  id              String      @id @default(uuid())
  associationId   String
  association     Association @relation(fields: [associationId], references: [id])

  name            String      // Display name: "Trésorier", "Admin"
  slug            String      // Internal key: "TREASURER", "ADMIN"
  color           String      @default("#6366f1")
  permissions     String      @default("[]") // JSON array of permission keys
  isSystem        Boolean     @default(false)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([slug, associationId])
}

// ─────────────────────────────────────────────────
// 2. USER (Membres)
// ─────────────────────────────────────────────────
model User {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  email         String
  password_hash String
  firstName     String?
  lastName      String?
  phone         String?
  avatar_url    String?
  gender        String?       // MALE, FEMALE, OTHER
  isVirtual     Boolean  @default(false) // Fantôme (ancêtre non-inscrit)

  // Enriched profile
  residence_city    String?   // Ville de résidence actuelle
  residence_country String?   // Pays de résidence (CM, FR, BE, CA...)
  family_branch     String?   // Concession / branche familiale (legacy text)
  familyBranchId    String?   // FK vers FamilyBranch structuré
  familyBranch      FamilyBranch? @relation(fields: [familyBranchId], references: [id])
  birth_date        DateTime? // Date de naissance
  membership_date   DateTime? // Date d'adhésion officielle

  // Roles: SUPER_ADMIN, ADMIN, TREASURER, SECRETARY, MEMBER
  role   String @default("MEMBER")
  // Status: ACTIVE, PENDING, SUSPENDED
  status String @default("PENDING")

  // Professional profile
  professionalStatus    String?   // STUDENT, EMPLOYED, SELF_EMPLOYED, CIVIL_SERVANT, RETIRED, UNEMPLOYED
  jobTitle              String?   // Intitulé du poste
  industrySector        String?   // HEALTH, TECH, CONSTRUCTION, EDUCATION, COMMERCE, AGRICULTURE, LEGAL, FINANCE, TRANSPORT, ARTS, OTHER
  employer              String?   // Nom de l'employeur
  educationLevel        String?   // BAC, LICENCE, MASTER, DOCTORATE, VOCATIONAL, NONE
  fieldOfStudy          String?   // Domaine d'études
  availableForMentoring Boolean   @default(false)
  profileVisibility     String    @default("MEMBERS") // PRIVATE, MEMBERS, PUBLIC

  // Invitation
  invitation_token   String?   @unique
  invitation_expires DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  fees               Fee[]
  ledGroups          Group[]             @relation("GroupLeader")
  memberOfGroups     Group[]             @relation("GroupMembers")
  eventRegistrations EventRegistration[]
  memberHistory      MemberHistory[]
  announcements      Announcement[]
  familyLinksFrom    FamilyLink[]    @relation("FamilyLinksFrom")
  familyLinksTo      FamilyLink[]    @relation("FamilyLinksTo")
  skills             UserSkill[]
  wallet             Wallet?
  secondaryAssociations UserAssociation[]
  commissionAssignments CommissionObjective[]
  notifications      Notification[]



  @@unique([email, associationId])
}

// ─────────────────────────────────────────────────
// 2c. SKILL (Compétences)
// ─────────────────────────────────────────────────
model Skill {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])
  name          String
  category      String?     // TECHNICAL, LANGUAGE, SOFT_SKILL, TRADE, OTHER
  users         UserSkill[]
  createdAt     DateTime    @default(now())

  @@unique([name, associationId])
}

model UserSkill {
  id      String  @id @default(uuid())
  userId  String
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillId String
  skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)
  level   String? // BEGINNER, INTERMEDIATE, EXPERT

  @@unique([userId, skillId])
}

// ─────────────────────────────────────────────────
// 2b. FAMILY LINK (Arbre Généalogique)
// ─────────────────────────────────────────────────
model FamilyLink {
  id             String      @id @default(uuid())
  associationId  String
  association    Association @relation(fields: [associationId], references: [id])

  fromUserId     String
  fromUser       User        @relation("FamilyLinksFrom", fields: [fromUserId], references: [id])

  toUserId       String
  toUser         User        @relation("FamilyLinksTo", fields: [toUserId], references: [id])

  // PARENT: fromUser est parent de toUser
  // SPOUSE: fromUser est conjoint de toUser
  relationType   String      // "PARENT" | "SPOUSE"

  createdAt      DateTime    @default(now())

  @@unique([fromUserId, toUserId, relationType])
}

// ─────────────────────────────────────────────────
// 3. MEMBER HISTORY
// ─────────────────────────────────────────────────
model MemberHistory {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Actions: CREATED, UPDATED, ROLE_CHANGED, SUSPENDED, REACTIVATED, etc.
  action      String
  description String?

  createdAt DateTime @default(now())
}

// ─────────────────────────────────────────────────
// 4. GROUP (Commissions)
// ─────────────────────────────────────────────────
model Group {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  name        String
  description String?

  leaderId String?
  leader   User?   @relation("GroupLeader", fields: [leaderId], references: [id])

  members User[] @relation("GroupMembers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Hierarchy (Sub-commissions)
  parentId    String?
  parent      Group?   @relation("GroupHierarchy", fields: [parentId], references: [id])
  children    Group[]  @relation("GroupHierarchy")

  // Attachment (National vs Branch)
  scope         String   @default("NATIONAL") // NATIONAL, BRANCH
  attachedToId  String?  // If BRANCH, specific Association ID (can match associationId or be a child)

  objectives CommissionObjective[]
  documents  Document[]
}

// ─────────────────────────────────────────────────
// OBJECTIVES (Feuille de route Commission)
// ─────────────────────────────────────────────────
model CommissionObjective {
  id          String   @id @default(uuid())
  groupId     String
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  
  dueDate     DateTime?
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, DONE, CANCELLED
  
  assignedToId String?
  assignedTo   User?    @relation(fields: [assignedToId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 5. CAMPAIGN (Appels de fonds)
// ─────────────────────────────────────────────────
model Campaign {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  name          String
  description   String?
  amount        Float
  due_date      DateTime
  auto_reminder Boolean  @default(false)
  // Scope: LOCAL, NETWORK_MEMBERS, NETWORK_BRANCHES
  scope         String   @default("LOCAL")

  fees Fee[]
  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Automation
  frequency   String            @default("ONETIME") // ONETIME, MONTHLY, QUARTERLY, YEARLY
  nextRunAt   DateTime?
  isActive    Boolean           @default(true)
}

// ─────────────────────────────────────────────────
// 6. FEE (Dettes / Cotisations)
// ─────────────────────────────────────────────────
model Fee {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  // For NETWORK_BRANCHES scope: fee targets an association instead of a user
  targetAssociationId String?
  targetAssociation   Association? @relation("BranchFees", fields: [targetAssociationId], references: [id])

  // Status: PENDING, PAID, OVERDUE
  status             String    @default("PENDING")
  payment_link_token String?   @unique
  last_reminder_at   DateTime?
  reminder_count     Int       @default(0)

  transactionId String?      @unique
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// TREASURY ACCOUNTS
// ─────────────────────────────────────────────────
model TreasuryAccount {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  name          String      // "Caisse Principale", "Compte BOA"
  type          String      @default("CASH") // CASH, BANK, MOBILE_MONEY, OTHER
  currency      String      @default("XAF")
  balance       Float       @default(0.0)

  transactions  Transaction[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

// ─────────────────────────────────────────────────
// 7. TRANSACTION (Livre de compte)
// ─────────────────────────────────────────────────
model Transaction {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  amount        Float
  // Type: INCOME, EXPENSE
  type          String
  // Category: COTISATION, DON, SUBVENTION, ACHAT, EVENEMENT, AUTRE
  category      String?
  // PaymentMethod: CASH, BANK_TRANSFER, MOBILE_MONEY, CARD, OTHER
  paymentMethod String?
  date          DateTime @default(now())
  description   String?

  fee Fee?

  proofDocumentId String?   @unique
  proofDocument   Document? @relation(fields: [proofDocumentId], references: [id])

  // Treasury Link
  treasuryAccountId String?
  treasuryAccount   TreasuryAccount? @relation(fields: [treasuryAccountId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 8. EVENT
// ─────────────────────────────────────────────────
model Event {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  title       String
  description String?
  location    String?
  start_date  DateTime
  end_date    DateTime?
  // Type: MEETING, AG, PARTY
  type        String   @default("MEETING")
  is_paid     Boolean   @default(false)
  price       Float?

  // Recurrence
  recurrenceType String   @default("NONE") // NONE, WEEKLY, MONTHLY, YEARLY
  recurrenceEnd  DateTime?
  parentId       String?
  parent         Event?   @relation("EventRecurrence", fields: [parentId], references: [id])
  children       Event[]  @relation("EventRecurrence")

  // Notification
  reminderSent   Boolean  @default(false)
  reminderTime   Int?     // Minutes before event (e.g. 1440 = 24h)

  campaignId String?
  campaign  Campaign? @relation(fields: [campaignId], references: [id])

  registrations EventRegistration[]
  documents     Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 9. EVENT REGISTRATION
// ─────────────────────────────────────────────────
model EventRegistration {
  id      String @id @default(uuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id])
  userId  String
  user    User   @relation(fields: [userId], references: [id])

  // Status: ATTENDING, ABSENT, PENDING
  status   String  @default("ATTENDING")
  has_paid Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId])
}

// ─────────────────────────────────────────────────
// 10. DOCUMENT (GED)
// ─────────────────────────────────────────────────
model Document {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  name         String
  file_url     String
  // Category: STATUTES, MEETING_MINUTES, INVOICE, ADMINISTRATIVE, OTHER
  category     String @default("OTHER")
  // AccessLevel: PUBLIC, MEMBERS_ONLY, ADMIN_ONLY
  access_level String @default("MEMBERS_ONLY")

  // Optional link to an event (e.g. minutes for an AG)
  eventId      String?
  event        Event? @relation(fields: [eventId], references: [id])

  // Optional link to a group/commission (e.g. working docs)
  groupId      String?
  group        Group? @relation(fields: [groupId], references: [id])

  transaction Transaction?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 11. ANNOUNCEMENT
// ─────────────────────────────────────────────────
model Announcement {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  title    String
  content  String
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  scope    String @default("LOCAL") // LOCAL = this association only, NETWORK = broadcast to all children

  createdAt DateTime @default(now())
}

// ─────────────────────────────────────────────────
// 12. WALLET (Portfolio Membre)
// ─────────────────────────────────────────────────
model Wallet {
  id            String      @id @default(uuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id])
  
  balance       Float       @default(0.0)
  currency      String      @default("XAF")
  status        String      @default("ACTIVE") // ACTIVE, FROZEN, CLOSED

  transactions  WalletTransaction[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

// ─────────────────────────────────────────────────
// 13. WALLET TRANSACTION
// ─────────────────────────────────────────────────
model WalletTransaction {
  id            String      @id @default(uuid())
  walletId      String
  wallet        Wallet      @relation(fields: [walletId], references: [id])

  amount        Float       // Positive (credit) or negative (debit)
  
  // Type: DEPOSIT (top-up), WITHDRAWAL, PAYMENT (fee payment), TRANSFER (p2p), ADJUSTMENT (admin)
  type          String
  
  // Status: PENDING, COMPLETED, FAILED, CANCELLED
  status        String      @default("COMPLETED")
  
  reference     String?     // External ref (MOMO txn id) or internal ref
  description   String?
  
  // Optional link to a Fee (if payment)
  feeId         String?
  
  createdAt     DateTime    @default(now())
}

// ─────────────────────────────────────────────────
// 14. USER ASSOCIATION (Multi-Appartenance)
// ─────────────────────────────────────────────────
model UserAssociation {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  associationId   String
  association     Association @relation("SecondaryMembers", fields: [associationId], references: [id], onDelete: Cascade)
  role            String      @default("MEMBER")
  joinedAt        DateTime    @default(now())

  @@unique([userId, associationId])
}

// ─────────────────────────────────────────────────
// 15. FAMILY BRANCH (Branches familiales structurées)
// ─────────────────────────────────────────────────
model FamilyBranch {
  id              String      @id @default(uuid())
  name            String      // "Branche Pierre Nounga"
  founderName     String?     // Nom du fondateur / patriarche
  description     String?
  associationId   String
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  members         User[]
  createdAt       DateTime    @default(now())
}

// ─────────────────────────────────────────────────
// 16. NOTIFICATION
// ─────────────────────────────────────────────────
model Notification {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  title         String
  message       String
  type          String   @default("INFO") // INFO, SUCCESS, WARNING, ERROR, ASSIGNMENT, OBJECTIVE, DOCUMENT
  
  read          Boolean  @default(false)
  readAt        DateTime?
  
  // Optional link or metadata
  link          String?  // URL to redirect
  metadata      String?  // JSON for extra data (e.g. entityId)

  createdAt     DateTime @default(now())
}

// ─────────────────────────────────────────────────
// 17. PAYMENT CONFIGURATION
// ─────────────────────────────────────────────────
model PaymentConfig {
  id            String      @id @default(uuid())
  associationId String      @unique
  association   Association @relation(fields: [associationId], references: [id])
  
  // Provider: STRIPE, ORANGE_MONEY, MTNC, MANUAL
  provider      String      @default("MANUAL")
  publicKey     String?     // API Key / Client ID
  secretKey     String?     // Secret Key
  isEnabled     Boolean     @default(false)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}
