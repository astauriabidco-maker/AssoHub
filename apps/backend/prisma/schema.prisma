// ASSOSHUB — Prisma Schema (SQLite)
// ⚠️ SQLite: No enum support → all status/role fields use String with @default

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ─────────────────────────────────────────────────
// 1. ASSOCIATION (Tenant)
// ─────────────────────────────────────────────────
model Association {
  id              String   @id @default(uuid())
  slug            String   @unique
  name            String
  slogan          String?
  logo_url        String?
  address_street  String?
  address_city    String?
  address_zip     String?
  address_country String?
  contact_email   String?
  contact_phone   String?
  legal_form      String? // Ex: "Association loi 1901", "ONG", etc.
  is_active       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Hierarchy (Federation / Antennes)
  parentId        String?
  parent          Association?  @relation("AssociationHierarchy", fields: [parentId], references: [id])
  children        Association[] @relation("AssociationHierarchy")
  networkLevel    String        @default("LOCAL") // INTERNATIONAL, NATIONAL, REGIONAL, LOCAL

  // Relations
  users         User[]
  roles         Role[]
  groups        Group[]
  campaigns     Campaign[]
  transactions  Transaction[]
  events        Event[]
  documents     Document[]
  announcements Announcement[]
  branchFees    Fee[]          @relation("BranchFees")
}

// ─────────────────────────────────────────────────
// 1b. ROLE (Dynamic per Association)
// ─────────────────────────────────────────────────
model Role {
  id              String      @id @default(uuid())
  associationId   String
  association     Association @relation(fields: [associationId], references: [id])

  name            String      // Display name: "Trésorier", "Admin"
  slug            String      // Internal key: "TREASURER", "ADMIN"
  color           String      @default("#6366f1")
  permissions     String      @default("[]") // JSON array of permission keys
  isSystem        Boolean     @default(false)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([slug, associationId])
}

// ─────────────────────────────────────────────────
// 2. USER (Membres)
// ─────────────────────────────────────────────────
model User {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  email         String
  password_hash String
  firstName     String?
  lastName      String?
  phone         String?
  avatar_url    String?

  // Roles: SUPER_ADMIN, ADMIN, TREASURER, SECRETARY, MEMBER
  role   String @default("MEMBER")
  // Status: ACTIVE, PENDING, SUSPENDED
  status String @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  fees               Fee[]
  ledGroups          Group[]             @relation("GroupLeader")
  memberOfGroups     Group[]             @relation("GroupMembers")
  eventRegistrations EventRegistration[]
  memberHistory      MemberHistory[]
  announcements      Announcement[]

  @@unique([email, associationId])
}

// ─────────────────────────────────────────────────
// 3. MEMBER HISTORY
// ─────────────────────────────────────────────────
model MemberHistory {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Actions: CREATED, UPDATED, ROLE_CHANGED, SUSPENDED, REACTIVATED, etc.
  action      String
  description String?

  createdAt DateTime @default(now())
}

// ─────────────────────────────────────────────────
// 4. GROUP (Commissions)
// ─────────────────────────────────────────────────
model Group {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  name        String
  description String?

  leaderId String?
  leader   User?   @relation("GroupLeader", fields: [leaderId], references: [id])

  members User[] @relation("GroupMembers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 5. CAMPAIGN (Appels de fonds)
// ─────────────────────────────────────────────────
model Campaign {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  name          String
  description   String?
  amount        Float
  due_date      DateTime
  auto_reminder Boolean  @default(false)
  // Scope: LOCAL, NETWORK_MEMBERS, NETWORK_BRANCHES
  scope         String   @default("LOCAL")

  fees Fee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 6. FEE (Dettes / Cotisations)
// ─────────────────────────────────────────────────
model Fee {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  // For NETWORK_BRANCHES scope: fee targets an association instead of a user
  targetAssociationId String?
  targetAssociation   Association? @relation("BranchFees", fields: [targetAssociationId], references: [id])

  // Status: PENDING, PAID, OVERDUE
  status             String    @default("PENDING")
  payment_link_token String?   @unique
  last_reminder_at   DateTime?
  reminder_count     Int       @default(0)

  transactionId String?      @unique
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 7. TRANSACTION (Livre de compte)
// ─────────────────────────────────────────────────
model Transaction {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  amount        Float
  // Type: INCOME, EXPENSE
  type          String
  // Category: COTISATION, DON, SUBVENTION, ACHAT, EVENEMENT, AUTRE
  category      String?
  // PaymentMethod: CASH, BANK_TRANSFER, MOBILE_MONEY, CARD, OTHER
  paymentMethod String?
  date          DateTime @default(now())
  description   String?

  fee Fee?

  proofDocumentId String?   @unique
  proofDocument   Document? @relation(fields: [proofDocumentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 8. EVENT
// ─────────────────────────────────────────────────
model Event {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  title       String
  description String?
  location    String?
  start_date  DateTime
  end_date    DateTime?
  is_paid     Boolean   @default(false)
  price       Float?

  registrations EventRegistration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 9. EVENT REGISTRATION
// ─────────────────────────────────────────────────
model EventRegistration {
  id      String @id @default(uuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id])
  userId  String
  user    User   @relation(fields: [userId], references: [id])

  // Status: REGISTERED, ATTENDED, CANCELLED
  status   String  @default("REGISTERED")
  has_paid Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 10. DOCUMENT (GED)
// ─────────────────────────────────────────────────
model Document {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  name         String
  file_path    String
  // Category: AG_REPORT, INVOICE, STATUTS, RECEIPT, OTHER
  category     String @default("OTHER")
  // AccessLevel: PUBLIC, MEMBERS_ONLY, ADMIN_ONLY
  access_level String @default("ADMIN_ONLY")

  transaction Transaction?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────────
// 11. ANNOUNCEMENT
// ─────────────────────────────────────────────────
model Announcement {
  id            String      @id @default(uuid())
  associationId String
  association   Association @relation(fields: [associationId], references: [id])

  title    String
  content  String
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  scope    String @default("LOCAL") // LOCAL = this association only, NETWORK = broadcast to all children

  createdAt DateTime @default(now())
}
